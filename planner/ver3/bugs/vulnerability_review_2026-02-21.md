# sarimax_rs 취약점 리뷰 (ver3, 수정 반영)

최종 갱신일: 2026-02-22  
대상: `Rust-python-arima/sarimax_rs/src`

## 처리 결과 요약
- 기존 High/Medium 이슈 중 재현 가능한 항목을 코드로 수정 완료.
- 회귀 방지를 위한 Python 입력검증 테스트를 보강.

## 해결된 항목

### 1) 짧은 시계열 + 고차 AR 입력 시 `PanicException`
- 상태: `Closed`
- 수정:
  - `Rust-python-arima/sarimax_rs/src/start_params.rs:56`
  - `Rust-python-arima/sarimax_rs/src/start_params.rs:383`
  - `Rust-python-arima/sarimax_rs/src/optimizer.rs:550`
- 내용:
  - `yule_walker()`의 부족 데이터 경로를 `None`으로 교정.
  - `assert_eq!` 기반 패닉 제거, `DataError` 반환으로 변경.
  - `fit()` 초기에 최소 관측치 가드 추가.

### 2) `exog`/`exog_forecast` NaN/Inf 비검증
- 상태: `Closed`
- 수정:
  - `Rust-python-arima/sarimax_rs/src/lib.rs:49`
  - `Rust-python-arima/sarimax_rs/src/lib.rs:164`
  - `Rust-python-arima/sarimax_rs/src/lib.rs:261`
  - `Rust-python-arima/sarimax_rs/src/lib.rs:408`
- 내용:
  - 모든 Python 공개 API 경계에서 exog 계열 finite 검증 추가.
  - `kalman` 결과 non-finite 방어 추가.
  - `Rust-python-arima/sarimax_rs/src/kalman.rs:502`

### 3) 배치 forecast의 `future_exog` 행 수 부족 시 silent fallback
- 상태: `Closed`
- 수정:
  - `Rust-python-arima/sarimax_rs/src/lib.rs:569`
  - `Rust-python-arima/sarimax_rs/src/forecast.rs:50`
- 내용:
  - batch 경로에서도 `future_exog`의 행 수/열 수를 사전 검증.
  - core forecast에서도 길이 미달 시 `InvalidInput` 반환.

### 4) Rust 공개 batch API 길이 불일치/zip truncation
- 상태: `Closed`
- 수정:
  - `Rust-python-arima/sarimax_rs/src/batch.rs:18`
  - `Rust-python-arima/sarimax_rs/src/batch.rs:27`
  - `Rust-python-arima/sarimax_rs/src/batch.rs:96`
- 내용:
  - `series`, `params_list`, `exog_list`, `future_exog_list` 길이 불일치 시 에러 결과 반환.
  - `zip` 기반 silent truncation 제거.

### 5) 공개 변환 함수 슬라이싱 패닉 (`transform/untransform`)
- 상태: `Closed`
- 수정:
  - `Rust-python-arima/sarimax_rs/src/optimizer.rs:31`
  - `Rust-python-arima/sarimax_rs/src/optimizer.rs:108`
  - `Rust-python-arima/sarimax_rs/src/optimizer.rs:250`
- 내용:
  - 기대 파라미터 길이 검증 추가.
  - `transform_params`를 `Result<Vec<f64>>`로 변경해 오류 전파.

### 6) 모델 차수 과대 입력으로 상태공간 폭증(DoS)
- 상태: `Closed` (Python API 경계)
- 수정:
  - `Rust-python-arima/sarimax_rs/src/lib.rs:23`
  - `Rust-python-arima/sarimax_rs/src/lib.rs:66`
- 내용:
  - `checked_*` 연산 기반 overflow 방어.
  - `k_states` 상한(`MAX_K_STATES`) 가드 추가.

## 추가 개선(품질)
- `batch_fit` 기본 method 정합화:
  - `Rust-python-arima/sarimax_rs/src/batch.rs:74` (`lbfgsb`)
- Python dict 조립부 `unwrap()` 제거:
  - `Rust-python-arima/sarimax_rs/src/lib.rs:435`
  - `Rust-python-arima/sarimax_rs/src/lib.rs:651`
- 내부 에러 -> Python 예외 매핑 세분화:
  - `Rust-python-arima/sarimax_rs/src/lib.rs:114`

## 테스트/검증
- Rust:
  - `cargo test --lib` -> `100 passed`
- Python:
  - `uv run python -m pytest python_tests/test_input_validation.py -q` -> `27 passed`
  - `uv run python -m pytest python_tests/test_batch.py -q` -> `6 passed`
  - `uv run python -m pytest python_tests/test_exog.py -q` -> `14 passed`
  - `uv run python -m pytest python_tests/test_loglike.py -q` -> `4 passed`
  - `uv run python -m pytest python_tests/test_fit.py -q` -> `9 passed`
  - `uv run python -m pytest python_tests/test_forecast.py -q` -> `9 passed`

## 잔여 리스크 (낮음)
- Rust crate를 Python wrapper 없이 직접 사용할 때, Python 경계에서 수행하는 일부 가드(예: `MAX_K_STATES`)를 우회할 수 있음.
- 필요 시 `StateSpace::new`/`optimizer::fit` 레벨에 동일 상한을 추가해 완전 차단 권장.
